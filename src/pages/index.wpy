<style lang="less">
@import "../style/calendar.less";
</style>
<template>
  <view class="main">
    <view class="demo5">
      <calendar
        calendar-style="calendar" header-style="header" board-style="board"
        binddayClick="dayClick"
        @nextMonth="nextMonth"
        days-color="{{daysStyle}}"></calendar>
    </view>
    <view class="work">
      <picker @change="chooseTimes" value="{{times}}" range="{{timesArray}}">
        <button class="picker">
          è®¾ç½®æ¬¡æ•°ï¼š{{todayTimes}}
        </button>
      </picker>
    </view>
    <button @tap="goJGY">é…ç½®åšæœäº‘</button>
  </view>
</template>

<script>
import wepy from 'wepy';
import dav from '../api/davApi';
import { accountExists } from '../api/saveLocal';

const MONTHS = ['Jan.', 'Feb.', 'Mar.', 'Apr.', 'May.', 'June.', 'July.', 'Aug.', 'Sept.', 'Oct.', 'Nov.', 'Dec.'];
export default class Index extends wepy.page {
  config = {
    usingComponents: {
      calendar: 'plugin://calendar/calendar'
    }
  };

  data = {
    year: new Date().getFullYear(),      // å¹´ä»½
    month: new Date().getMonth() + 1,    // æœˆä»½
    day: new Date().getDate(),
    str: MONTHS[new Date().getMonth()],  // æœˆä»½å­—ç¬¦ä¸²
    daysStyle: null,
    times: null,
    timesArray: ['0ğŸ˜˜', '1ğŸ˜‘', '2â˜¹ï¸', '3ğŸ˜£', '4ğŸ˜µ', '>=5ğŸ˜±']
  };

  computed = {
    todayTimes() {
      if (!this.times) {
        return 'æœªé€‰æ‹©';
      } else {
        return this.timesArray[this.times];
      }
    }
  };

  methods = {
    goJGY() {
      wx.navigateTo({
        url: 'setJGY'
      });
    },
    dayClick(e) {
      console.log(e.detail);
      let detail = e.detail;
      let item = {
        month: 'current',
        day: detail.day,
        color: 'white',
        background: '#58cc69'
      };
      console.log(item);
      this.daysStyle.push(item);
      this.$apply();
    },
    nextMonth(e) {
      this.circleToday(e.detail);
    },
    prevMonth(e) {
      this.circleToday(e.detail);
    },
    dateChange(e) {
      console.log(e.detail);
    },
    chooseTimes(e) {
      this.times = e.detail.value;
    }
  };

  async onLoad() {
    if (await accountExists()) {
      this.text = await dav.getAsync();
      this.$apply();
    }
    this.test();
    this.circleToday();
  }

  // åœˆå‡ºä»Šå¤©
  circleToday(detail = {}) {
    let year = detail.currentYear || this.year;
    let month = detail.currentMonth || this.month;
    if (year === this.year && month === this.month) {
      this.daysStyle.push({
        month: 'current',
        day: this.day,
        background: '#ccc',
        color: 'white'
      });
    }
  }

  test() {
    const days_count = new Date(this.data.year, this.data.month, 0).getDate();
    let style = [];
    for (let i = 1; i <= days_count; i++) {
      const date = new Date(this.data.year, this.data.month - 1, i);
      if (date.getDay() == 0) {
        style.push({
          month: 'current', day: i, color: '#f488cd'
        });
      } else {
        style.push({
          month: 'current', day: i, color: '#a18ada'
        });
      }
    }
    this.daysStyle = style;
    this.$apply();
  }
}
</script>
